# Import python packages
import streamlit as st
from snowflake.snowpark.context import get_active_session
from snowflake.snowpark.functions import col

# ã‚¢ãƒ—ãƒªã®ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜
st.title(":cup_with_straw: Pending Smoothie Orders :cup_with_straw:")
st.write(" Orders that need to be filled. ")

# Snowparkã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–å¾—
session = get_active_session()

# æœªå®Œäº†ã®æ³¨æ–‡ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
# BOOLEANã®FALSEã¯0ã¨ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™
# ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’Streamlitã® data_editor ã«æ¸¡ã™
my_dataframe = session.table("smoothies.public.orders").filter(col("ORDER_FILLED") == 0).collect()

# Streamlitã§ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã€ç·¨é›†å¯èƒ½ã«ã™ã‚‹
# ç·¨é›†ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã¯å³åº§ã«Snowflakeãƒ†ãƒ¼ãƒ–ãƒ«ã«æ›¸ãæˆ»ã•ã‚Œã¾ã™
# key='pending_orders' ã‚’è¿½åŠ ã—ã¦ã€Streamlitã«ä¸€æ„ã®ã‚­ãƒ¼ã‚’ä¸ãˆã¾ã™
if my_dataframe:
    edited_df = st.data_editor(
        data=my_dataframe, 
        key='pending_orders', 
        use_container_width=True
)

submitted = st.button('Submit')

if submitted:
    try:
        og_dataset = session.table("smoothies.public.orders")
        edited_dataset = session.create_dataframe(editable_df)
        og_dataset.merge(edited_dataset
                     , (og_dataset['ORDER_UID'] == edited_dataset['ORDER_UID'])
                     , [when_matched().update({'ORDER_FILLED': edited_dataset['ORDER_FILLED']})]
                    )
        st.success("Someone clicked the button.", icon="ğŸ‘")
    except:
        st.write(" Something went wrong. ")
        
else:
    st.success ('There are no pending orders right now', icon="ğŸ‘")
